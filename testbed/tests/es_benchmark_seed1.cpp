#include "test.h"
#include <string>
#include "car.h"
#include "chromosome.h"
#include <algorithm>
#include "es_benchmark_seed1.hpp"
#include <iostream>
#include "settings.h"

ESBenchmarkSeed1::ESBenchmarkSeed1()
{
	blocked_environment = nullptr;
}

void ESBenchmarkSeed1::Step(Settings& settings)
{	
	if(blocked_environment == nullptr) 
	{
		blocked_environment = new RandomTrack(true, settings.m_seed);	

		std::thread thread = std::thread([&]() {
			std::vector<Chromosome> cars {
				{ { -1.40947,3.33867,0.664098,2.02331,-0.789912,0.283467,-4.22899,2.12154,0.626879,-0.589122,0.134152,-0.689913,1.59957,-4.35033,3.48799,1.48576,-0.525083,1.01047,-0.284946,1.95286,1.63649,-1.3947,-0.455445,1.33717,0.659162,-0.994306,-1.91633,1.28992,1.0544,0.239294,0.799867,1.44854 }
				},
				{ { -1.34254,2.77852,1.96346,2.03842,1.65576,-0.883999,-0.338317,2.18958,0.293332,-0.254225,-0.786506,-0.393182,1.85326,-2.91368,2.8098,1.63223,-0.456717,1.023,-0.792659,0.602946,1.83317,-0.367612,-0.755923,1.8626,0.816038,-1.68726,-1.36289,-0.0532756,1.21996,0.558007,0.836011,1.10054 }
				},
				{ { 1.23172,1.58208,-0.961399,-0.152305,-1.40711,-3.52487,1.09184,1.76378,-0.324951,0.169049,-1.87576,0.653553,-0.28068,0.615594,0.833145,-0.145624,-3.71903,0.111686,1.57014,-3.83783,0.524206,0.524062,4.62487,1.12221,1.52598,1.07277,1.49888,-0.035017,-1.45523,-0.0109419,-2.76209,-1.89912 }
				},
				{ { -1.33449,4.52321,3.70357,2.38846,0.869323,1.91141,-1.7445,1.71181,-0.314244,-0.85919,1.09481,-1.17754,1.64182,-4.92674,4.36379,1.90572,-0.478741,0.943701,-0.713955,3.28116,1.90119,-1.14899,-0.428792,0.658593,0.892251,-0.422259,0.157504,3.1598,1.12963,0.800961,1.14253,2.18033 }
				},
				{ { -1.30378,2.34645,2.18994,2.13789,0.884323,-0.548365,0.144172,2.2943,0.19159,-0.375857,-0.271666,-0.631576,1.79449,-2.41151,1.99647,1.01554,-0.665393,1.22594,-0.699728,0.471043,1.58099,-0.500927,-0.726044,1.33754,0.835102,-1.86937,-1.22183,0.20355,1.42477,0.483058,0.512687,0.634192 }
				},
				{ { -1.43756,3.38925,1.0173,1.64294,0.13809,-0.040811,-3.54202,2.0032,0.0620544,-0.728678,0.548828,-0.632022,1.26219,-3.42748,4.28812,1.73712,-0.462246,0.626316,-0.138531,1.88954,1.07689,-2.88091,-0.435965,1.19563,0.606453,-1.21673,-0.839878,1.64032,1.0846,0.510989,0.98712,1.67677 }
				},
				{ { -1.41744,4.50889,3.75318,2.29442,0.661895,1.84666,-1.61401,1.71009,-0.308054,-1.01155,1.08747,-1.24392,1.6422,-4.78829,4.43294,1.84818,-0.512208,0.860169,-0.791697,2.7212,1.83621,-1.00646,-0.415109,0.564517,0.933403,-0.820743,0.203932,3.0868,1.17521,0.735135,1.06031,2.13286 }
				},
				{ { -1.37214,4.52271,3.70869,2.34204,0.687904,1.78425,-1.70695,1.71542,-0.362855,-0.96981,1.0412,-1.15131,1.64155,-4.89169,4.37931,1.83937,-0.521984,0.931047,-0.739075,2.55367,1.81743,-0.964664,-0.400725,0.56436,0.936157,-0.771741,0.194409,2.97013,1.17858,0.741626,0.96941,2.19455 }
				},
				{ { -1.49759,4.54648,3.51147,2.26144,0.682383,1.87732,-1.59002,1.7761,-0.371096,-0.989877,1.03663,-1.25319,1.647,-4.89054,4.31493,1.84011,-0.49996,0.970815,-0.832744,2.81708,1.79991,-1.0513,-0.3598,0.481395,0.9712,-0.8289,0.228946,3.10124,1.26156,0.690572,0.935311,2.38694 }
				},
				{ { -1.43114,4.36324,2.70527,2.3671,0.174668,1.75029,-1.0647,1.71338,-0.350738,-0.964126,0.842392,-1.46709,1.41576,-4.87003,4.31087,1.81047,-0.494689,1.10429,-0.561041,1.54623,1.37849,-1.97408,-0.227956,1.08225,0.902863,-1.79199,0.497882,2.76964,1.08581,0.689272,0.846057,1.79219 }
				},
				{ { -1.33592,4.54784,4.09841,2.26524,0.767178,1.88075,-1.69909,1.7108,-0.294582,-0.82303,1.01267,-1.31828,1.65878,-4.94432,4.2381,1.8548,-0.485002,0.91752,-0.785439,3.11954,1.58105,-1.02237,-0.378105,0.692392,0.882718,-0.643044,0.149163,3.0576,1.12836,0.74157,1.08909,2.02294 }
				},
				{ { 0.937432,1.96636,-0.519319,-1.90381,-2.36196,-2.64511,1.89112,0.716304,-1.69896,0.660922,0.436538,0.765552,-0.49171,0.815552,-0.427242,-0.442689,-3.37428,-0.0676926,2.47249,-2.76556,0.263268,0.71827,1.36828,1.40123,0.920297,0.579379,-0.95027,-0.374426,-0.281251,-0.444428,-2.39069,-1.83128 }
				},
				{ { -1.30469,3.95314,2.70595,1.75433,0.474738,0.346495,-2.27369,1.94852,-0.55601,-0.700441,0.434402,-1.09501,1.51878,-3.73293,3.84442,1.71713,-0.419578,1.295,0.171989,2.33946,1.07703,-2.59278,-1.01249,1.14424,0.257702,-1.49717,-0.268213,2.33265,0.951459,0.56554,1.38247,1.31964 }
				},
				{ { -1.41963,4.558,3.79248,2.24108,0.815926,1.85404,-1.73587,1.7067,-0.279325,-0.983141,1.12811,-1.30359,1.65363,-4.6774,4.44585,1.82454,-0.514717,0.765522,-0.788319,2.75584,1.7246,-0.806544,-0.43143,0.54965,0.924547,-0.739333,0.18057,3.08764,1.20206,0.719546,1.11519,2.153 }
				},
				{ { -1.38618,4.44349,1.74339,2.45864,0.409986,1.11696,-0.725185,1.85659,-0.209493,-0.865055,0.909353,-1.54459,1.59948,-4.22105,4.35372,1.56981,-0.474918,0.720885,-0.1986,2.30341,1.34587,-2.13707,-0.503546,1.13475,0.54531,-1.58955,-0.181264,2.77132,0.895899,0.6722,1.08879,1.893 }
				},
				{ { -1.36608,4.3214,2.41065,1.92672,0.184297,0.822457,-2.10329,1.89452,-0.335913,-0.805207,0.643736,-1.37797,1.54727,-3.68823,4.70483,1.59278,-0.463336,1.1248,-0.0639861,2.2594,1.37386,-2.20402,-0.52579,1.31657,0.300825,-1.56485,-0.412459,2.59702,0.656084,0.704501,1.48468,1.25465 }
				},
				{ { 1.87467,0.904289,2.14339,2.14535,-1.51659,-2.25427,1.35623,1.21725,1.00335,0.273344,1.72307,0.560871,0.0946994,0.818288,-0.38045,-0.0801961,-0.0973398,0.322278,0.157355,-1.14501,0.592204,0.846485,2.4908,-0.663649,0.63747,1.16597,-0.579264,-0.329395,-1.15796,0.384267,0.175672,-1.75494 }
				},
				{ { -1.07666,3.78694,2.64716,1.75735,0.583805,0.97719,-3.00076,1.9646,-0.445927,-0.63162,0.691023,-0.918021,1.41187,-3.82889,4.28506,1.95643,-0.400429,1.37784,0.162588,2.896,1.14332,-2.40647,-0.852183,1.47837,0.283821,-1.12163,-0.894204,2.29912,0.906513,0.476436,0.634039,1.63864 }
				},
				{ { -1.29972,4.29134,2.96153,2.42467,0.289999,2.19114,-0.945401,1.71221,-0.314254,-0.974468,1.37098,-1.3684,1.49147,-4.81778,4.55875,1.98266,-0.482395,0.963373,-0.299534,1.2481,1.10415,-2.27053,-0.0455034,1.26344,0.987298,-1.82346,0.301039,2.74774,1.16861,0.700813,0.533816,1.62654 }
				},
				{ { 0.658946,-1.21168,1.55544,0.663537,0.388918,-0.25622,-0.310598,-0.961685,-0.103866,-1.24084,0.207724,0.206308,1.01709,0.28535,1.21121,-1.49031,-1.57569,1.70159,1.55393,1.68224,0.907241,2.17003,-0.145682,-0.31769,0.776039,0.663055,0.0217179,0.659355,-1.70149,0.249843,0.530629,-1.1227 }
				},
				{ { -1.37258,4.56223,3.56002,2.19814,0.821358,1.86209,-1.65025,1.71536,-0.34039,-1.0161,1.16846,-1.31563,1.63832,-4.8073,4.42607,1.82074,-0.508304,0.916846,-0.798894,2.80683,1.74971,-0.795976,-0.407574,0.522102,0.902625,-0.936325,0.21313,3.07353,1.17071,0.751045,0.994316,1.92703 }
				},
				{ { -1.43043,4.25001,2.90742,2.17694,0.219476,1.1299,-1.5283,1.86125,0.0567535,-0.914998,0.674694,-1.42118,1.56667,-4.27233,4.41315,1.59633,-0.495893,1.20995,-0.171834,2.30459,1.08771,-1.89625,-0.593917,1.37214,0.502426,-1.58983,-0.196384,2.53035,0.566426,0.725079,1.19614,1.77091 }
				},
				{ { -2.00146,2.6398,1.62541,2.35822,-0.0500478,-0.0405515,-6.02312,2.14669,1.2231,-0.723178,-0.197425,-0.628557,1.56984,-4.29407,4.68041,1.91457,-0.559551,0.773586,0.154436,1.41542,2.06792,0.0293531,-1.14722,1.99406,0.855385,-1.33799,-1.23796,1.30364,0.539369,0.336999,1.26647,1.73132 }
				}
			};

			blocked_environment->evaluate_function(cars);
		});

		pthread = thread.native_handle();
		thread.detach();
	}

	blocked_environment->Lock();

	blocked_environment->Step(settings);
	blocked_environment->DeleteCars();

	blocked_environment->Unlock();
}

Test* ESBenchmarkSeed1::Create()
{
	return new ESBenchmarkSeed1;
}

ESBenchmarkSeed1::~ESBenchmarkSeed1() {
	pthread_cancel(pthread);
	
	delete blocked_environment;
	blocked_environment = nullptr;
}

static int testIndex = RegisterTest("BEST CARS", "ES SEED 1", ESBenchmarkSeed1::Create);